# Nextcloud AIO Integration Guide

## üéØ Nextcloud AIO Specific Configuration

This Minecraft AI Chatbot is specifically designed to work with **Nextcloud All-In-One (AIO)** deployments. The configuration and setup process differs significantly from standard Nextcloud installations.

## üìã Prerequisites

- **Nextcloud AIO** must be installed and running
- **Docker** environment with access to AIO containers
- **x.ai API key** for the language model
- **Bot user account** created in Nextcloud

## üîß Nextcloud AIO Bot Management

### Accessing the Nextcloud AIO Container

All bot management commands must be run from within the Nextcloud AIO container:

```bash
# Access the Nextcloud AIO container
docker exec -it nextcloud-aio-nextcloud bash
```

### Installing Bots in Nextcloud AIO

**Important**: Bots must be installed through the Nextcloud AIO container, not directly on the host system.

```bash
# Inside the Nextcloud AIO container
# Install the Talk app (required for bots)
occ app:install spreed

# Enable the Talk app
occ app:enable spreed

# Install the bots app
occ app:install integration_openai

# Enable the bots app
occ app:enable integration_openai
```

### Bot Configuration Commands

#### List Available Bots
```bash
# Inside Nextcloud AIO container
occ integration_openai:bot:list
```

#### Add a New Bot
```bash
# Inside Nextcloud AIO container
occ integration_openai:bot:add \
  --name "MinecraftBot" \
  --description "Minecraft knowledge assistant powered by x.ai" \
  --prompt "You are a helpful Minecraft assistant for kids. Answer questions about Minecraft in a kid-friendly way."
```

#### Configure Bot Settings
```bash
# Set bot avatar (optional)
occ integration_openai:bot:avatar \
  --bot-id 1 \
  --avatar-path /path/to/avatar.png

# Configure bot permissions
occ integration_openai:bot:permissions \
  --bot-id 1 \
  --rooms "all" \
  --users "all"
```

#### Remove a Bot
```bash
# Inside Nextcloud AIO container
occ integration_openai:bot:remove --bot-id 1
```

### Bot Token Management

#### Generate Bot Token
```bash
# Inside Nextcloud AIO container
# Create a dedicated bot user first
occ user:add minecraft_bot --password-from-env --display-name "Minecraft Bot"

# Add bot user to users group
occ group:adduser users minecraft_bot

# Generate app password for the bot
occ user:app-password:create minecraft_bot "Minecraft Bot API Access"
```

#### List Bot Tokens
```bash
# Inside Nextcloud AIO container
occ user:app-password:list minecraft_bot
```

### Shared Secret Configuration

**Critical Security Requirement**: Nextcloud AIO uses webhook signatures for security. You must configure the shared secret for proper webhook verification.

#### Finding the Shared Secret

```bash
# Inside Nextcloud AIO container
# Check if shared secret is already configured
occ config:list spreed | grep shared_secret

# If not found, generate a new shared secret
# The shared secret is automatically generated by Nextcloud Talk
# You can find it in the Talk app settings or generate one
```

#### Shared Secret Location

The shared secret can be found in:

1. **Nextcloud Admin Settings** ‚Üí **Talk** ‚Üí **Webhook settings**
2. **Environment variable** in the AIO container:
   ```bash
   docker exec nextcloud-aio-nextcloud env | grep SHARED_SECRET
   ```
3. **Database** (if you have direct access):
   ```bash
   # Inside AIO container
   occ config:list spreed
   ```

#### Setting the Shared Secret

```bash
# Inside Nextcloud AIO container
# Set the shared secret for Talk webhooks
occ config:app:set spreed shared_secret --value "your-generated-shared-secret"

# Verify it's set
occ config:app:get spreed shared_secret
```

## üîê Authentication Setup

## üê≥ Docker Network Configuration

### Nextcloud AIO Network

The bot container must connect to the Nextcloud AIO Docker network:

```yaml
# docker-compose.yml
services:
  minecraft_bot:
    networks:
      - minecraft_bot_network
      - nextcloud-aio  # This is the critical AIO network
```

### Network Discovery

Find the correct network name:

```bash
# List all Docker networks
docker network ls

# Inspect Nextcloud AIO network
docker network inspect nextcloud-aio
```

## üîê Authentication Setup

### Bot User Creation

1. **Access Nextcloud AIO container:**
   ```bash
   docker exec -it nextcloud-aio-nextcloud bash
   ```

2. **Create bot user:**
   ```bash
   occ user:add minecraft_bot --password-from-env --display-name "Minecraft Bot"
   ```

3. **Generate app token:**
   ```bash
   occ user:app-password:create minecraft_bot "Minecraft Bot API"
   ```

4. **Record the generated token** - this is your `NEXTCLOUD_BOT_TOKEN`

### Environment Configuration

```env
# .env file
NEXTCLOUD_URL=https://your-domain.com
NEXTCLOUD_BOT_TOKEN=generated-app-token-here
SHARED_SECRET=your-nextcloud-shared-secret-here
XAI_API_KEY=your-xai-api-key-here
NETWORK_NAME=nextcloud-aio
```

## üöÄ Deployment Steps

### 1. Prepare Nextcloud AIO

```bash
# Access AIO container
docker exec -it nextcloud-aio-nextcloud bash

# Install required apps
occ app:install spreed
occ app:enable spreed
occ app:install integration_openai
occ app:enable integration_openai

# Create bot user
occ user:add minecraft_bot --password-from-env --display-name "Minecraft Bot"
occ user:app-password:create minecraft_bot "Minecraft Bot API"

# IMPORTANT: Get the shared secret for webhook security
SHARED_SECRET=$(occ config:app:get spreed shared_secret)
echo "Shared Secret: $SHARED_SECRET"
# Copy this value for your .env file
```

### 2. Configure Bot Container

```bash
# Clone the bot repository
git clone <your-repo-url>
cd mc_ai

# Configure environment
cp .env.example .env
# Edit .env with your settings

# Start the bot
docker-compose up -d
```

### 3. Verify Integration

```bash
# Check bot is running
docker-compose logs -f minecraft_bot

# Test health endpoint
curl http://localhost:8111/health

# Test in Nextcloud Talk
@MinecraftBot How do I craft a sword?
```

## üêõ Troubleshooting AIO-Specific Issues

### Bot Not Appearing in Talk

**Check AIO container logs:**
```bash
docker logs nextcloud-aio-nextcloud
```

**Verify bot installation:**
```bash
docker exec -it nextcloud-aio-nextcloud bash
occ integration_openai:bot:list
```

### Network Connectivity Issues

**Verify network connection:**
```bash
# Check if bot can reach Nextcloud
docker exec minecraft_bot curl -I https://nextcloud-aio-nextcloud:443

# Test network connectivity
docker network inspect nextcloud-aio
```

### Permission Issues

**Check bot user permissions:**
```bash
docker exec -it nextcloud-aio-nextcloud bash
occ user:list
occ group:list
```

**Verify app passwords:**
```bash
occ user:app-password:list minecraft_bot
```

### Webhook Registration Issues

**Check Talk app configuration:**
```bash
docker exec -it nextcloud-aio-nextcloud bash
occ config:list spreed
```

**Verify webhook endpoints:**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-domain.com/ocs/v2.php/apps/spreed/api/v1/webhook
```

**Shared Secret Issues:**
```bash
# Check if shared secret is configured
docker exec -it nextcloud-aio-nextcloud bash
occ config:app:get spreed shared_secret

# If empty, set it
occ config:app:set spreed shared_secret --value "your-secret-here"

# Verify bot can use the shared secret
grep SHARED_SECRET /path/to/mc_ai/.env
```

## üìö AIO-Specific Commands Reference

### User Management
```bash
# List users
occ user:list

# Add user
occ user:add username --password-from-env --display-name "Display Name"

# Delete user
occ user:delete username

# Reset password
occ user:resetpassword username
```

### App Management
```bash
# List apps
occ app:list

# Install app
occ app:install app_name

# Enable app
occ app:enable app_name

# Disable app
occ app:disable app_name

# Update app
occ app:update app_name
```

### Bot Management
```bash
# List bots
occ integration_openai:bot:list

# Add bot
occ integration_openai:bot:add --name "BotName" --description "Description"

# Remove bot
occ integration_openai:bot:remove --bot-id ID

# Configure bot
occ integration_openai:bot:config --bot-id ID --key setting --value value
```

## üîÑ Migration from Standard Nextcloud

If migrating from a standard Nextcloud installation to AIO:

1. **Backup existing configuration**
2. **Export bot settings**
3. **Reinstall apps in AIO container**
4. **Recreate bot users and tokens**
5. **Update network configuration**
6. **Test integration**

## üìû Support

For AIO-specific issues:
- Check Nextcloud AIO documentation
- Review container logs: `docker logs nextcloud-aio-nextcloud`
- Verify network connectivity
- Ensure proper user permissions

## ‚ö†Ô∏è Important Notes

- **Container Access Required**: All bot management must happen inside the AIO container
- **Network Dependency**: Bot relies on `nextcloud-aio` Docker network
- **App Dependencies**: Both `spreed` and `integration_openai` apps must be installed
- **Token Security**: Use app passwords, not user passwords for bot authentication
- **Shared Secret Required**: Webhook signature verification requires `SHARED_SECRET` from Nextcloud AIO
- **User Context**: Bot operates within Nextcloud user permissions system

---

*This guide is specific to Nextcloud AIO deployments. Standard Nextcloud installations require different setup procedures.*
