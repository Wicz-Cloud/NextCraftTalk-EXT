version: '3.8'

services:
  # Ollama - Local LLM Server
  ollama:
    image: ollama/ollama:latest
    container_name: minecraft_ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - nextcloud-aio
    restart: unless-stopped
#    deploy:
#      resources:
#        reservations:
#          devices:
#            - driver: nvidia
#              count: all
#              capabilities: [gpu]
    # For CPU-only, remove the deploy section above

  # Minecraft Bot Service
  minecraft_bot:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: minecraft_bot
    env_file: .env  # Loads environment variables from .env file
    ports:
      - "${BOT_PORT}:${BOT_PORT}"  # Exposes bot API port (default 8111)
    volumes:
      - ./wiki_data:/app/wiki_data  # Mounts scraped wiki data
      - ./chroma_db:/app/chroma_db  # Mounts vector database
      - ./.env:/app/.env            # Mounts environment config
      - ./prompt_template.txt:/app/prompt_template.txt  # Mounts prompt template for editing without restart
    environment:
      - NEXTCLOUD_URL=${NEXTCLOUD_URL}      # Nextcloud instance URL
      - NEXTCLOUD_BOT_TOKEN=${NEXTCLOUD_BOT_TOKEN}  # Bot authentication token
      - OLLAMA_URL=http://ollama:11434     # Ollama service URL (internal network)
      - MODEL_NAME=${MODEL_NAME:-phi3:mini} # LLM model name from .env
      - BOT_NAME=${BOT_NAME:-MinecraftBot}  # Bot display name
    depends_on:
      - ollama  # Wait for Ollama service to start
    networks:
      - minecraft_bot_network
      - nextcloud-aio  # Connects to Nextcloud network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BOT_PORT}/health"]  # Health check endpoint
      interval: 30s

  # Nginx Reverse Proxy (optional, for HTTPS)
  # nginx:
  #   image: nginx:alpine
  #   container_name: minecraft_bot_nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - minecraft_bot
  #   networks:
  #     - nextcloud-aio
  #   restart: unless-stopped
  #   # Comment out if not using reverse proxy

volumes:
  ollama_data:
    driver: local

networks:
  minecraft_bot_network:
    driver: bridge
  nextcloud-aio:
    external: true
